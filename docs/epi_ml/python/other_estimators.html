<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>epi_ml.python.other_estimators API documentation</title>
<meta name="description" content="Main" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>epi_ml.python.other_estimators</code></h1>
</header>
<section id="section-intro">
<p>Main</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">&#34;&#34;&#34;Main&#34;&#34;&#34;
import argparse
from datetime import datetime
import json
import os
from pathlib import Path
import sys

import numpy as np
from sklearn.svm import SVC
from sklearn.ensemble import RandomForestClassifier
from sklearn.metrics import matthews_corrcoef, make_scorer
from sklearn.preprocessing import StandardScaler
from sklearn.pipeline import Pipeline
from skopt import BayesSearchCV
from skopt.space import Real, Categorical, Integer
from tabulate import tabulate
import pandas as pd

from epi_ml.python.argparseutils.directorychecker import DirectoryChecker

from epi_ml.python.core import metadata
from epi_ml.python.core.data_source import EpiDataSource
from epi_ml.python.core.epiatlas_treatment import EpiAtlasTreatment
from epi_ml.python.core.estimators import EstimatorAnalyzer


RNG = np.random.RandomState(42)
SCORES = {
    &#34;acc&#34;:&#34;accuracy&#34;,
    &#34;precision&#34;:&#34;precision_macro&#34;,
    &#34;recall&#34;:&#34;recall_macro&#34;,
    &#34;f1&#34;:&#34;f1_macro&#34;,
    &#34;mcc&#34;:make_scorer(matthews_corrcoef)
}
SVM_SEARCH = {
    &#34;model__C&#34;: Real(1e-6, 1e+6, prior=&#34;log-uniform&#34;),
    &#34;model__gamma&#34;: Real(1e-6, 1e+1, prior=&#34;log-uniform&#34;),
    &#34;model__degree&#34;: Integer(1,8),
    &#34;model__kernel&#34;: Categorical([&#34;linear&#34;, &#34;poly&#34;, &#34;rbf&#34;])
}
RF_SEARCH = {
    &#34;model__n_estimators&#34;: Categorical([500, 1000]),
    &#34;model__criterion&#34;: Categorical([&#34;gini&#34;, &#34;entropy&#34;, &#34;log_loss&#34;]),
    &#34;model__max_features&#34;: Categorical([&#34;sqrt&#34;, &#34;log2&#34;]),
    &#34;model__bootstrap&#34;: Categorical([True]),
    &#34;model__random_state&#34;: Categorical([RNG]),
    &#34;model__min_samples_leaf&#34;: Integer(1,5),
    &#34;model__min_samples_split&#34;: Categorical([0.01, 0.05, 0.1, 0.3])
}


def time_now():
    &#34;&#34;&#34;Return datetime of call without microseconds&#34;&#34;&#34;
    return datetime.utcnow().replace(microsecond=0)


def parse_arguments(args: list) -&gt; argparse.Namespace:
    &#34;&#34;&#34;argument parser for command line&#34;&#34;&#34;
    arg_parser = argparse.ArgumentParser()
    arg_parser.add_argument(&#34;category&#34;, type=str, help=&#34;The metatada category to analyse.&#34;)
    arg_parser.add_argument(&#34;hdf5&#34;, type=Path, help=&#34;A file with hdf5 filenames. Use absolute path!&#34;)
    arg_parser.add_argument(&#34;chromsize&#34;, type=Path, help=&#34;A file with chrom sizes.&#34;)
    arg_parser.add_argument(&#34;metadata&#34;, type=Path, help=&#34;A metadata JSON file.&#34;)
    arg_parser.add_argument(&#34;logdir&#34;, type=DirectoryChecker(), help=&#34;Directory for the output logs.&#34;)
    return arg_parser.parse_args(args)


def on_step(result):
    &#34;&#34;&#34;BayesSearchCV callback&#34;&#34;&#34;
    print(f&#34;Best params yet: {result.x}&#34;)


def tune_estimator(my_model, ea_handler: EpiAtlasTreatment, params:dict):
    &#34;&#34;&#34;Apply Bayesian optimization over hyperparameters search space.&#34;&#34;&#34;
    pipe = Pipeline(steps=[
        (&#34;scaler&#34;, StandardScaler()),
        (&#34;model&#34;, my_model)
    ])

    opt = BayesSearchCV(
        pipe, search_spaces=params, cv=ea_handler.split(),
        n_iter=10, random_state=RNG, return_train_score=True, error_score=-1, verbose=3,
        scoring=SCORES, refit=&#34;acc&#34;,
        n_jobs=1
        )

    total_data = ea_handler.create_total_data()
    print(f&#34;Number of files used globally {len(total_data)}&#34;)

    opt.fit(X=total_data.signals, y=total_data.encoded_labels, callback=on_step)

    print(f&#34;best params: {opt.best_params_}&#34;)
    return opt


def main(args):
    &#34;&#34;&#34;main called from command line, edit to change behavior&#34;&#34;&#34;
    begin = time_now()
    print(f&#34;begin {begin}&#34;)

    # --- PARSE params and LOAD external files ---
    cli = parse_arguments(args)

    my_datasource = EpiDataSource(
        cli.hdf5,
        cli.chromsize,
        cli.metadata
        )


    my_metadata = metadata.Metadata(my_datasource.metadata_file)
    my_metadata.remove_category_subsets(label_category=&#34;track_type&#34;, labels=[&#34;Unique.raw&#34;])


    if os.getenv(&#34;ASSAY_LIST&#34;) is not None:
        assay_list = json.loads(os.environ[&#34;ASSAY_LIST&#34;])
        print(f&#34;Going to only keep targets with {assay_list}&#34;)
    else:
        assay_list = my_metadata.unique_classes(cli.category)
        print(&#34;No assay list&#34;)


    loading_begin = time_now()
    ea_handler = EpiAtlasTreatment(my_datasource, cli.category, assay_list, n_fold=9, test_ratio=0.1, min_class_size=10)
    loading_time = time_now() - loading_begin
    print(f&#34;Initial hdf5 loading time: {loading_time}&#34;)

    print(&#34;Starting RF optimization&#34;)
    start_train = time_now()
    opt = tune_estimator(RandomForestClassifier(), ea_handler, RF_SEARCH)
    print(f&#34;Total RF optimisation time: {time_now()-start_train}&#34;)

    df = pd.DataFrame(opt.cv_results_)
    print(tabulate(df, headers=&#39;keys&#39;, tablefmt=&#39;psql&#39;))
    df.to_csv(cli.logdir / &#34;RF_optim.csv&#34;, sep=&#34;,&#34;)


    print(&#34;Starting SVM optimization&#34;)
    start_train = time_now()
    opt = tune_estimator(SVC(), ea_handler, SVM_SEARCH)
    print(f&#34;Total SVM optimisation time: {time_now()-start_train}&#34;)

    df = pd.DataFrame(opt.cv_results_)
    print(tabulate(df, headers=&#39;keys&#39;, tablefmt=&#39;psql&#39;))
    df.to_csv(cli.logdir / &#34;SVM_optim.csv&#34;, sep=&#34;,&#34;)



if __name__ == &#34;__main__&#34;:
    os.environ[&#34;TF_CPP_MIN_LOG_LEVEL&#34;] = &#34;3&#34;
    main(sys.argv[1:])</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="epi_ml.python.other_estimators.main"><code class="name flex">
<span>def <span class="ident">main</span></span>(<span>args)</span>
</code></dt>
<dd>
<div class="desc"><p>main called from command line, edit to change behavior</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def main(args):
    &#34;&#34;&#34;main called from command line, edit to change behavior&#34;&#34;&#34;
    begin = time_now()
    print(f&#34;begin {begin}&#34;)

    # --- PARSE params and LOAD external files ---
    cli = parse_arguments(args)

    my_datasource = EpiDataSource(
        cli.hdf5,
        cli.chromsize,
        cli.metadata
        )


    my_metadata = metadata.Metadata(my_datasource.metadata_file)
    my_metadata.remove_category_subsets(label_category=&#34;track_type&#34;, labels=[&#34;Unique.raw&#34;])


    if os.getenv(&#34;ASSAY_LIST&#34;) is not None:
        assay_list = json.loads(os.environ[&#34;ASSAY_LIST&#34;])
        print(f&#34;Going to only keep targets with {assay_list}&#34;)
    else:
        assay_list = my_metadata.unique_classes(cli.category)
        print(&#34;No assay list&#34;)


    loading_begin = time_now()
    ea_handler = EpiAtlasTreatment(my_datasource, cli.category, assay_list, n_fold=9, test_ratio=0.1, min_class_size=10)
    loading_time = time_now() - loading_begin
    print(f&#34;Initial hdf5 loading time: {loading_time}&#34;)

    print(&#34;Starting RF optimization&#34;)
    start_train = time_now()
    opt = tune_estimator(RandomForestClassifier(), ea_handler, RF_SEARCH)
    print(f&#34;Total RF optimisation time: {time_now()-start_train}&#34;)

    df = pd.DataFrame(opt.cv_results_)
    print(tabulate(df, headers=&#39;keys&#39;, tablefmt=&#39;psql&#39;))
    df.to_csv(cli.logdir / &#34;RF_optim.csv&#34;, sep=&#34;,&#34;)


    print(&#34;Starting SVM optimization&#34;)
    start_train = time_now()
    opt = tune_estimator(SVC(), ea_handler, SVM_SEARCH)
    print(f&#34;Total SVM optimisation time: {time_now()-start_train}&#34;)

    df = pd.DataFrame(opt.cv_results_)
    print(tabulate(df, headers=&#39;keys&#39;, tablefmt=&#39;psql&#39;))
    df.to_csv(cli.logdir / &#34;SVM_optim.csv&#34;, sep=&#34;,&#34;)</code></pre>
</details>
</dd>
<dt id="epi_ml.python.other_estimators.on_step"><code class="name flex">
<span>def <span class="ident">on_step</span></span>(<span>result)</span>
</code></dt>
<dd>
<div class="desc"><p>BayesSearchCV callback</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def on_step(result):
    &#34;&#34;&#34;BayesSearchCV callback&#34;&#34;&#34;
    print(f&#34;Best params yet: {result.x}&#34;)</code></pre>
</details>
</dd>
<dt id="epi_ml.python.other_estimators.parse_arguments"><code class="name flex">
<span>def <span class="ident">parse_arguments</span></span>(<span>args: list) ‑> argparse.Namespace</span>
</code></dt>
<dd>
<div class="desc"><p>argument parser for command line</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def parse_arguments(args: list) -&gt; argparse.Namespace:
    &#34;&#34;&#34;argument parser for command line&#34;&#34;&#34;
    arg_parser = argparse.ArgumentParser()
    arg_parser.add_argument(&#34;category&#34;, type=str, help=&#34;The metatada category to analyse.&#34;)
    arg_parser.add_argument(&#34;hdf5&#34;, type=Path, help=&#34;A file with hdf5 filenames. Use absolute path!&#34;)
    arg_parser.add_argument(&#34;chromsize&#34;, type=Path, help=&#34;A file with chrom sizes.&#34;)
    arg_parser.add_argument(&#34;metadata&#34;, type=Path, help=&#34;A metadata JSON file.&#34;)
    arg_parser.add_argument(&#34;logdir&#34;, type=DirectoryChecker(), help=&#34;Directory for the output logs.&#34;)
    return arg_parser.parse_args(args)</code></pre>
</details>
</dd>
<dt id="epi_ml.python.other_estimators.time_now"><code class="name flex">
<span>def <span class="ident">time_now</span></span>(<span>)</span>
</code></dt>
<dd>
<div class="desc"><p>Return datetime of call without microseconds</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def time_now():
    &#34;&#34;&#34;Return datetime of call without microseconds&#34;&#34;&#34;
    return datetime.utcnow().replace(microsecond=0)</code></pre>
</details>
</dd>
<dt id="epi_ml.python.other_estimators.tune_estimator"><code class="name flex">
<span>def <span class="ident">tune_estimator</span></span>(<span>my_model, ea_handler: <a title="epi_ml.python.core.epiatlas_treatment.EpiAtlasTreatment" href="core/epiatlas_treatment.html#epi_ml.python.core.epiatlas_treatment.EpiAtlasTreatment">EpiAtlasTreatment</a>, params: dict)</span>
</code></dt>
<dd>
<div class="desc"><p>Apply Bayesian optimization over hyperparameters search space.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def tune_estimator(my_model, ea_handler: EpiAtlasTreatment, params:dict):
    &#34;&#34;&#34;Apply Bayesian optimization over hyperparameters search space.&#34;&#34;&#34;
    pipe = Pipeline(steps=[
        (&#34;scaler&#34;, StandardScaler()),
        (&#34;model&#34;, my_model)
    ])

    opt = BayesSearchCV(
        pipe, search_spaces=params, cv=ea_handler.split(),
        n_iter=10, random_state=RNG, return_train_score=True, error_score=-1, verbose=3,
        scoring=SCORES, refit=&#34;acc&#34;,
        n_jobs=1
        )

    total_data = ea_handler.create_total_data()
    print(f&#34;Number of files used globally {len(total_data)}&#34;)

    opt.fit(X=total_data.signals, y=total_data.encoded_labels, callback=on_step)

    print(f&#34;best params: {opt.best_params_}&#34;)
    return opt</code></pre>
</details>
</dd>
</dl>
</section>
<section>
</section>
</article>
<nav id="sidebar">
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3>Super-module</h3>
<ul>
<li><code><a title="epi_ml.python" href="index.html">epi_ml.python</a></code></li>
</ul>
</li>
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="epi_ml.python.other_estimators.main" href="#epi_ml.python.other_estimators.main">main</a></code></li>
<li><code><a title="epi_ml.python.other_estimators.on_step" href="#epi_ml.python.other_estimators.on_step">on_step</a></code></li>
<li><code><a title="epi_ml.python.other_estimators.parse_arguments" href="#epi_ml.python.other_estimators.parse_arguments">parse_arguments</a></code></li>
<li><code><a title="epi_ml.python.other_estimators.time_now" href="#epi_ml.python.other_estimators.time_now">time_now</a></code></li>
<li><code><a title="epi_ml.python.other_estimators.tune_estimator" href="#epi_ml.python.other_estimators.tune_estimator">tune_estimator</a></code></li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>